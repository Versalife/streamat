# Worklog - 09-16-2025

## Project Enhancements

This worklog outlines the plan for several enhancements to the `streammat` project based on user feedback.

### 1. Unload with Deletion

*   **Goal:** When a matrix is unloaded via the API, its underlying TileDB array should be deleted from disk to free up space.
*   **File to Modify:** `streammat/server.py`
*   **Endpoint:** `DELETE /api/v1/matrix/{matrix_name}`
*   **Implementation Details:**
    *   Get the URI of the matrix before removing it from the server state.
    *   Use `tiledb.remove()` to delete the array.
    *   Handle potential errors during deletion and log them.
    *   Return a `207 Multi-Status` if the matrix is unloaded from memory but the disk deletion fails.

### 2. Progress Communication for Matrix Loading

*   **Goal:** Provide real-time progress updates to the client when a large matrix is being loaded.
*   **File to Modify:** `streammat/server.py`, `streammat/core.py`
*   **Endpoint:** `PUT /api/v1/matrix/{matrix_name}`
*   **Implementation Plan:**
    *   **Phase 1 (Streaming Response):** Investigate using `fastapi.responses.StreamingResponse` to send progress events as part of the response stream. This is the simplest approach.
    *   **Phase 2 (WebSockets):** If streaming responses are not suitable, implement a WebSocket-based solution. This would involve:
        *   A new endpoint like `/ws/status/{task_id}`.
        *   The `load_matrix` endpoint would return a task ID.
        *   The client would connect to the WebSocket to receive progress updates for that task.

### 3. API for Shape Discovery

*   **Goal:** Allow users to query the expected input/output shapes for matrix operations without trial and error.
*   **File to Modify:** `streammat/models.py`, `streammat/server.py`
*   **Implementation Details:**
    *   Update the `MatrixInfo` Pydantic model in `models.py` to include shape information for `matvec` and `rmatvec`.
    *   The new fields will describe the expected input and output vector dimensions (e.g., `matvec_input_shape`, `matvec_output_shape`).
    *   Update the `get_status` endpoint in `server.py` to populate this new information.

### 4. Ergonomic API for Sparse Data

*   **Goal:** Improve the API to allow users to send large sparse vectors and matrices efficiently.
*   **File to Modify:** `streammat/models.py`, `streammat/server.py`, `streammat/core.py`
*   **Implementation Plan:**
    *   **Sparse Vectors:**
        *   Update the `VectorRequest` model in `models.py` to accept a sparse representation (e.g., `{ "indices": [...], "values": [...] }`).
        *   Modify the `perform_matvec` and `perform_rmatvec` endpoints in `server.py` to handle this new format.
        *   Adapt the core `matvec`/`rmatvec` methods in `core.py` to work efficiently with the sparse input.
    *   **Sparse Matrices (for future operations):**
        *   Design a new model for sparse matrices in COO format (`row_indices`, `col_indices`, `values`).
        *   This will be considered for new endpoints that might accept raw matrix data.
